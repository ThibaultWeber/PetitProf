document.addEventListener('DOMContentLoaded',function(){const form=document.getElementById('graph-form');const resultDiv=document.getElementById('graph-result');let analyseDiv=document.getElementById('analyse-math-div');if (!analyseDiv){analyseDiv=document.createElement('div');analyseDiv.id='analyse-math-div';analyseDiv.style.margin='40px auto 0 auto';analyseDiv.style.maxWidth='900px';analyseDiv.style.width='100%';analyseDiv.style.textAlign='left';resultDiv.parentNode.insertBefore(analyseDiv,resultDiv.nextSibling);}function setFieldError(idx,message){let input=document.getElementById('fonction'+(idx+1));let errId='fonction-error-'+(idx+1);let old=document.getElementById(errId);if (old) old.remove();if (message){let err=document.createElement('div');err.id=errId;err.style.color='red';err.style.fontSize='0.95em';err.style.marginTop='2px';err.textContent=message;input.parentNode.insertBefore(err,input.nextSibling);}}form.addEventListener('submit',function(e){e.preventDefault();const fonctions=[];for (let i=1;i<=5;i++){setFieldError(i-1,'');const val=document.getElementById('fonction'+i).value.trim();if (val) fonctions.push(val);}if (fonctions.length===0){resultDiv.innerHTML='<p style="color:red;">Veuillez saisir au moins une fonction.</p>';analyseDiv.innerHTML='';return;}const x_min=document.getElementById('x_min').value;const x_max=document.getElementById('x_max').value;const y_min=document.getElementById('y_min').value;const y_max=document.getElementById('y_max').value;const params={fonctions:fonctions};if (x_min!=='') params.x_min=parseFloat(x_min);if (x_max!=='') params.x_max=parseFloat(x_max);if (y_min!=='') params.y_min=parseFloat(y_min);if (y_max!=='') params.y_max=parseFloat(y_max);resultDiv.innerHTML='<p>⏳ Génération du graphique...</p>';analyseDiv.innerHTML='';fetch('/api/trace-courbe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(params)}) .then(response=>{if (!response.ok) throw new Error('Erreur serveur');return response.json();}) .then(data=>{if (data.success){resultDiv.innerHTML=`<img src="${data.image_url}?t=${Date.now()}" alt="Courbe tracée" style="max-width:100%;border:1px solid #ccc;box-shadow:0 2px 8px #aaa;">`;if (data.analyse_html){analyseDiv.innerHTML=data.analyse_html;}else{analyseDiv.innerHTML='';}if (data.courbes_status){let champIdx=0;for (let i=1;i<=5;i++){let val=document.getElementById('fonction'+i).value.trim();if (!val) continue;let status=data.courbes_status[champIdx];if (status&&!status.success){setFieldError(i-1,status.error);}champIdx++;}}}else{resultDiv.innerHTML=`<p style='color:red;'>${data.error||'Erreur inconnue.'}</p>`;analyseDiv.innerHTML='';}}) .catch(err=>{resultDiv.innerHTML=`<p style='color:red;'>Erreur:${err.message}</p>`;analyseDiv.innerHTML='';});});});